<div class="container-fluid">
  <div class="panel-body" style="padding: 20px">
    <div class="text-center" style="margin-bottom: 20px">
      <button class="btn btn-primary pull-center" >
        {{'management.locationDetails.calendar.form.addButton' | translate}}
      </button>
    </div>
    <app-calendar
      [events]="events"
      [refresh]="refresh"
      (timeslotPickedEvent)="timeslotPickedHandler($event)"
      >
    </app-calendar>
  </div>

  <hr>

  <div class="container-fluid">
    <div class="row">
      <!-- Title -->
      <h3>
        {{'management.locationDetails.calendar.reservations.title' | translate}}
      </h3>

      <!-- Show table if user has searched, else show a message instead of an empty table -->
      <div *ngIf="showReservations === false" class="alert alert-info"  >
        {{'management.locationDetails.calendar.reservations.selectSlot' | translate}}
      </div>
      <div *ngIf="showReservations === null" class="alert alert-info">
        {{'management.locationDetails.calendar.reservations.loading' | translate}}
      </div>
      <!-- If an error has occurred while fetching the reservations, show the error -->
      <div *ngIf="errorOnRetrievingReservations" class="alert alert-error">
        {{'management.locationDetails.calendar.reservations.error' | translate}}
      </div>


      <!-- Component showing the location reservations -->
      <app-location-reservations
        *ngIf="showReservations === true && !errorOnRetrievingReservations"
        [locationReservations]="locationReservations"
        [currentCalendarPeriod]="currentCalendarPeriod"
        [currentTimeSlot]="currentTimeSlot"
        (reservationChange)="loadReservations()">
      </app-location-reservations>
    </div>


    <hr>

    <!-- Form to edit the calendar -->
    <div #CPtable class="row">
      <!-- Title -->
      <div class="row">
        <h3 class="inline-block">
          {{'management.locationDetails.calendar.form.title' | translate}}
        </h3>
        <button class="btn btn-primary pull-right" (click)="open(addTimeslotModal)">
          {{'management.locationDetails.calendar.form.addButton' | translate}}
        </button>
      </div>

      <!-- The form itself -->
      <div style="margin-top: 10px; margin-bottom: 10px;">
        <table style="width: 100%;" *ngIf="calendarPeriods.length > 0; else noCalendarPeriodsForLocation">
          <thead>
          <tr>
            <th>{{'management.locationDetails.calendar.form.startsAt' | translate}}</th>
            <th>{{'management.locationDetails.calendar.form.endsAt' | translate}}</th>
            <th>{{'management.locationDetails.calendar.form.openingTime' | translate}}</th>
            <th>{{'management.locationDetails.calendar.form.closingTime' | translate}}</th>
            <th>{{'management.locationDetails.calendar.form.reservable' | translate}}</th>
            <th>{{'management.locationDetails.calendar.form.numberOfSeats' | translate}}</th>
            <th><!-- update --></th>
            <th><!-- delete --></th>
          </tr>
          </thead>

          <tbody>
          <tr *ngFor="let calendarPeriod of calendarPeriods">
            <td>{{calendarPeriod.startsAt.format('DD/MM/YYYY')}}</td>
            <td>{{calendarPeriod.endsAt.format('DD/MM/YYYY')}}</td>
            <td>{{calendarPeriod.openingTime.format('HH:mm')}}</td>
            <td>{{calendarPeriod.closingTime.format('HH:mm')}}</td>
            <td>{{(calendarPeriod.reservable ? calendarPeriod.reservableFrom.format('DD/MM/YYYY - HH:mm'):
              'general.notAvailableAbbreviation') | translate}}</td>
            <td>{{calendarPeriod.seatCount}}</td>

            <!-- Edit icon -->
            <td class="hover" style="padding-left: 10px; padding-right: 10px; padding-top: 10px"
                (click)="prepareUpdate(calendarPeriod, updateCalendarPeriodModal)" *ngIf="!calendarPeriod.isLocked() || isAdmin">
              <span class="glyphicon glyphicon-pencil pointerCursor"></span>
            </td>
            <!-- Delete icon -->
            <td class="hover" style="padding-left: 10px; padding-right: 10px; padding-top: 10px"
                (click)="prepareDelete(calendarPeriod, deleteCalendarPeriodModal)" *ngIf="!calendarPeriod.isLocked() || isAdmin">
              <span class="glyphicon glyphicon-trash pointerCursor"></span>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal view to add a calendar period -->
<ng-template #addTimeslotModal>
  <app-location-add-timeslot-dialog
  [location]="getLocation() | async"
  (onNewTimeslot)="newTimeslot($event)"
  >
  </app-location-add-timeslot-dialog>
</ng-template>

<!-- Modal view to update a calendar period -->
<ng-template #updateTimeslotModal>
  <app-location-add-timeslot-dialog
  [location]="getLocation() | async"
  [timeslot]="currentTimeSlot"
  (onNewTimeslot)="updateTimeslot($event)"

  >
</app-location-add-timeslot-dialog>

</ng-template>

<!-- Modal view to ask whether the user is sure to delete a timeslot -->
<ng-template #deleteTimeslotModal>
  <!-- Header -->
  <div class="modal-header">
    <h5 class="modal-title" id="deleteCalendarPeriodModalTitle">
      {{'management.locationDetails.calendar.deleteModalView.title' | translate}}
    </h5>
  </div>

  <!-- Body -->
  <div class="modal-body">
    <div>
      <b>{{'management.locationDetails.calendar.deleteModalView.body' | translate}}</b>
      <br><br>
      <ul *ngIf="prepareToUpdatePeriod !== null">
        <li><b style="margin-right: 5px"><i>{{'management.locationDetails.calendar.form.startsAt' | translate}}</i></b>{{prepareToUpdatePeriod.startsAt.format('DD/MM/YYYY')}}</li>
        <li><b style="margin-right: 5px"><i>{{'management.locationDetails.calendar.form.endsAt' | translate}}</i></b>{{prepareToUpdatePeriod.endsAt.format('DD/MM/YYYY')}}</li>
        <li><b style="margin-right: 5px"><i>{{'management.locationDetails.calendar.form.openingTime' | translate}}</i></b>{{prepareToUpdatePeriod.openingTime.format('HH:mm')}}</li>
        <li><b style="margin-right: 5px"><i>{{'management.locationDetails.calendar.form.closingTime' | translate}}</i></b>{{prepareToUpdatePeriod.closingTime.format('HH:mm')}}</li>
        <li><b style="margin-right: 5px"><i>{{'management.locationDetails.calendar.form.reservable' | translate}}</i></b>{{(prepareToUpdatePeriod.reservable ? 'general.yes' : 'general.no') |translate}}</li>
      </ul>
    </div>
  </div>

  <div class="alert alert-danger">
    <p>{{'management.locationDetails.calendar.deleteModalView.warning' | translate}}</p>
  </div>


  <!-- Footer -->
  <div class="modal-footer">
    <button type="button" class="btn btn-danger danger" (click)="delete()">
      {{'general.buttons.delete' | translate}}
    </button>
    <button type="button" class="btn btn-secondary" (click)="closeModal()">
      {{'general.buttons.cancel' | translate}}
    </button>
  </div>

  <!-- Feedback to the user -->
  <div class="container-fluid">
    <div class="alert alert-info" *ngIf="successDeletingLocationReservation === null">
      {{'general.waitingForServer' | translate}}
    </div>

    <div class="alert alert-success" *ngIf="successDeletingLocationReservation === true">
      {{'management.locationDetails.calendar.deleteModalView.success' | translate}}
    </div>

    <div class="alert alert-error" *ngIf="successDeletingLocationReservation === false">
      {{'management.locationDetails.calendar.deleteModalView.error' | translate}}
    </div>
  </div>
</ng-template>

<ng-template #noCalendarPeriodsForLocation>
  <div class="row" style="margin-top: 20px">
    <div class="alert alert-info">
      {{'management.locationDetails.calendar.form.noCalendarPeriodsForLocation' | translate}}
    </div>
  </div>
</ng-template>

<ng-template #loadingOrError>
  <div class="alert alert-error" *ngIf="errorSubject | async; else loading" style="margin-top: 10px;">
    {{'management.locationDetails.calendar.errorLoadingCalendarPeriods' | translate}}
  </div>

  <ng-template #loading>
    <div class="alert alert-info" style="margin-top: 10px;">
      {{'general.waitingForServer' | translate}}
    </div>
  </ng-template>
</ng-template>
