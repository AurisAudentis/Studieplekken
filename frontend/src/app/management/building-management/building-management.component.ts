import { Component, ElementRef, OnInit, TemplateRef, ViewChild } from '@angular/core';
import { Observable } from 'rxjs';
import { Building } from 'src/app/shared/model/Building';
import {
  AbstractControl,
  FormControl,
  FormGroup,
  Validators,
} from '@angular/forms';
import { BuildingService } from 'src/app/services/api/buildings/buildings.service';
import { BsModalService } from 'ngx-bootstrap/modal';
import { AuthenticationService } from 'src/app/services/authentication/authentication.service';
import * as Leaf from 'leaflet';

// Leaflet stuff.
const iconRetinaUrl = './assets/marker-icon-2x.png';
const iconUrl = './assets/marker-icon.png';
const shadowUrl = './assets/marker-shadow.png';
const iconDefault = Leaf.icon({
  iconRetinaUrl,
  iconUrl,
  shadowUrl,
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  tooltipAnchor: [16, -28],
  shadowSize: [41, 41]
});
Leaf.Marker.prototype.options.icon = iconDefault;

@Component({
  selector: 'app-building-management',
  templateUrl: './building-management.component.html',
  styleUrls: ['./building-management.component.css'],
})
export class BuildingManagementComponent implements OnInit {
  buildingsObs: Observable<Building[]>;

  buildingFormGroup = new FormGroup({
    buildingId: new FormControl({ value: '', disabled: true }),
    name: new FormControl('', Validators.required.bind(this)),
    address: new FormControl('', Validators.required.bind(this)),
    latitude: new FormControl('', Validators.required.bind(this)),
    longitude: new FormControl('', Validators.required.bind(this)),
  });

  successGettingBuildings: boolean = undefined;
  successAddingBuilding: boolean = undefined;
  successUpdatingBuilding: boolean = undefined;
  successDeletingBuilding: boolean = undefined;
  showDelete: boolean = this.authenticationService.isAdmin();

  leafletMap: Leaf.Map;
  @ViewChild('leafletMapElementAdding', { static: false }) leafletMapElementAdding: ElementRef;
  @ViewChild('leafletMapElementUpdating', { static: false }) leafletMapElementUpdating: ElementRef;

  constructor(
    private buildingService: BuildingService,
    private modalService: BsModalService,
    private authenticationService: AuthenticationService
  ) {}

  get buildingId(): AbstractControl {
    return this.buildingFormGroup.get('buildingId');
  }

  get name(): AbstractControl {
    return this.buildingFormGroup.get('name');
  }

  get address(): AbstractControl {
    return this.buildingFormGroup.get('address');
  }

  get latitude(): AbstractControl {
    return this.buildingFormGroup.get('latitude');
  }

  get longitude(): AbstractControl {
    return this.buildingFormGroup.get('longitude');
  }

  // ********************
  // *   CRUD: Create   *
  // ********************/

  get building(): Building {
    return {
      buildingId: this.buildingId.value as number,
      name: this.name.value as string,
      address: this.address.value as string,
      latitude: this.latitude.value as number,
      longitude: this.longitude.value as number,
    };
  }

  ngOnInit(): void {
    this.buildingsObs = this.buildingService.getAllBuildings();
    this.buildingsObs.subscribe(
      () => {
        this.successGettingBuildings = true;
      },
      () => {
        this.successGettingBuildings = false;
      }
    );
  }

  // ********************
  // *   CRUD: Update   *
  // ********************/

  prepareFormGroup(building: Building): void {
    this.buildingFormGroup.setValue({
      buildingId: building.buildingId,
      name: building.name,
      address: building.address,
      latitude: building.latitude,
      longitude: building.longitude,
    });
  }

  closeModal(): void {
    this.modalService.hide();
  }

  // ********************
  // *   CRUD: Delete   *
  // ********************/

  prepareAdd(template: TemplateRef<unknown>): void {
    // reset the feedback boolean
    this.successAddingBuilding = undefined;

    // prepare the buildingFormGroup, note that the buildingId won't be shown
    // because this is automatically added by the database
    this.buildingFormGroup.setValue({
      buildingId: -1, // building id must be generated by backend
      name: '',
      address: '',
      latitude: 0,
      longitude: 0,
    });

    this.modalService.show(template);
    this.setupLeafletMap(this.leafletMapElementAdding.nativeElement);
  }

  addBuilding(): void {
    this.successAddingBuilding = null;
    this.buildingService.addBuilding(this.building).subscribe(
      () => {
        this.successAddingBuilding = true;
        // reload the buildings
        this.buildingsObs = this.buildingService.getAllBuildings();
        this.modalService.hide();
      },
      () => {
        this.successAddingBuilding = false;
      }
    );
  }

  // *****************
  // *   Auxiliary   *
  // *****************/

  prepareUpdate(building: Building, template: TemplateRef<unknown>): void {
    // reset the feedback boolean
    this.successUpdatingBuilding = undefined;

    // prepare the tagFormGroup
    this.prepareFormGroup(building);

    this.modalService.show(template);
    this.setupLeafletMap(this.leafletMapElementUpdating.nativeElement);
  }

  updateBuildingInFormGroup(): void {
    this.successUpdatingBuilding = null;
    this.buildingService
      .updateBuilding(this.building.buildingId, this.building)
      .subscribe(
        () => {
          this.successUpdatingBuilding = true;
          // and reload the tags
          this.buildingsObs = this.buildingService.getAllBuildings();
          this.modalService.hide();
        },
        () => {
          this.successUpdatingBuilding = false;
        }
      );
  }

  prepareToDelete(building: Building, template: TemplateRef<unknown>): void {
    // reset the feedback boolean
    this.successDeletingBuilding = undefined;

    // prepare the tagFormGroup
    this.prepareFormGroup(building);

    this.modalService.show(template);
  }

  deleteBuildingInFormGroup(): void {
    this.successDeletingBuilding = null;
    this.buildingService.deleteBuilding(this.building.buildingId).subscribe(
      () => {
        this.successDeletingBuilding = true;
        // and reload the tags
        this.buildingsObs = this.buildingService.getAllBuildings();
        this.modalService.hide();
      },
      () => {
        this.successDeletingBuilding = false;
      }
    );
  }

  validBuildingFormGroup(): boolean {
    return !this.buildingFormGroup.invalid;
  }

  setupLeafletMap(leafletMapElement): void {
    if (this.leafletMap) {
      this.leafletMap.off();
      this.leafletMap.remove();
    }

    const originalTile = Leaf.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
      id: 'mapbox/streets-v11',
      tileSize: 512,
      zoomOffset: -1,
      // Token has restriction to only work with https://studieplekken.ugent.be, https://studieplekken-dev.ugent.be and
      // https://localhost:4200. Token created by Ieben Smessaert (iesmessa).
      accessToken: 'pk.eyJ1Ijoic21lc3NpZSIsImEiOiJja3JnMzR2ZXEwZG82MnVrd3l5NHFnYTk1In0.jER8bBqoIeiNrKX-HGlrZQ',
      maxZoom: 25
    });

    // Use coordinates of UFO as placeholder.
    const coordinates = new Leaf.LatLng(51.0466368, 3.72738899573349);
    this.leafletMap = new Leaf.Map(leafletMapElement, {
      center: coordinates,
      zoom: 18,
      layers: [originalTile]
    });
    new Leaf.Marker(coordinates).addTo(this.leafletMap);

    // tslint:disable-next-line:no-shadowed-variable
    this.leafletMap.on('click', <LeafletMouseEvent>(e) => {
      const coords = e.latlng;
      this.latitude.setValue(coords.latitude);
      this.longitude.setValue(coords.longitude);
    });
  }
}
